<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-calm_escript/calm_escript">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">EScript and Task Library | Calm 301</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://github.com/ncm301/calm_escript/"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="EScript and Task Library | Calm 301"><meta data-rh="true" name="description" content="Overview"><meta data-rh="true" property="og:description" content="Overview"><link data-rh="true" rel="icon" href="/ncm301/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://github.com/ncm301/calm_escript/"><link data-rh="true" rel="alternate" href="https://github.com/ncm301/calm_escript/" hreflang="en"><link data-rh="true" rel="alternate" href="https://github.com/ncm301/calm_escript/" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/ncm301/blog/rss.xml" title="Calm 301 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/ncm301/blog/atom.xml" title="Calm 301 Atom Feed"><link rel="stylesheet" href="/ncm301/assets/css/styles.70a3dea8.css">
<link rel="preload" href="/ncm301/assets/js/runtime~main.b995eb59.js" as="script">
<link rel="preload" href="/ncm301/assets/js/main.2f042511.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(e){}return e}()||function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/ncm301/"><div class="navbar__logo"><img src="/ncm301/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/ncm301/img/logo.svg" alt="My Site Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/ncm301/">NCM Self Service Bootcamp</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/mat0606/ncm301" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ncm301/">NCM Self Service Bootcamp</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/ncm301/what_is_calm/">NCM Self Service 101</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/ncm301/calm_linux_track/calm_day2_linux/">NCM Self Service 201</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ncm301/calm_linux_track/calm_day2_linux/">Linux Day 2 Operations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/ncm301/calm_escript/">EScript and Task Library</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ncm301/calm_aws/">Gateway to Infrastructure</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/ncm301/calm_api/">NCM Self Service 301</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/ncm301/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">NCM Self Service 201</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">EScript and Task Library</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>NCM Self Service: EScript and Task Library</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2><p>In the <a href="/ncm301/calm_linux_track/calm_iaas_linux/">Calm Linux</a> and <a href="/ncm301/calm_windows_track/calm_iaas_windows/">Calm Windows</a>  labs you explored how Calm can utilize Bash and PowerShell scripts to automate application deployments. While shell scripts can be both powerful and versatile, they require the
deployment of an endpoint VM on which to copy and execute the script locally.</p><p>There are use cases that would be better served to execute code directly within NCM Self Service, such as making API calls to other RESTful services like Nutanix Era, GitHub, IFTTT, etc.</p><p>To fill this need, NCM Self Service offers a script type called <a href="https://portal.nutanix.com/#/page/docs/details?targetId=Nutanix-Calm-Admin-Operations-Guide-v250:nuc-supported-escript-modules-functions-c.html" target="_blank" rel="noopener noreferrer">EScript</a>.
Short for Epsilon Script (Epsilon is the orchestration engine that drives Calm), EScript is a sandboxed Python interpreter. It contains many commonly used modules for scripting and automation. In particular, it contains the <strong>requests</strong> module as <strong>urlreq</strong>, used to create external API calls.</p><div class="theme-admonition theme-admonition-info alert alert--info admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_S0QG"><p>The interpreter is sandboxed because the script runs <strong>directly</strong> within the Calm engine, which means it runs directly within Prism Central. Allowing the user to import unknown and unvetted modules into Prism Central is a security concern.</p></div></div><p>In this lab you will leverage EScript to perform API calls against an existing web service, your Prism Central VM. You will also leverage Set Variable to set the data returned from an API call to a Calm macro, and
the Task Library to understand how common code can be used across multiple blueprints or projects.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="lab-setup">Lab Setup<a href="#lab-setup" class="hash-link" aria-label="Direct link to Lab Setup" title="Direct link to Lab Setup">​</a></h2><p>This lab assumes basic familiarity with Nutanix Calm.</p><p><strong>It does NOT require the Task Manager application deployed as part of other Calm labs.</strong> Instead, you will create a new, blank Blueprint and add a credential used to authenticate to Prism Central.</p><ol><li><p>In <strong>Prism Central</strong>, select <strong>Menu &gt; Services &gt; Calm &gt; Blueprints</strong></p></li><li><p>Click <strong>+ Create Blueprint &gt; Multi VM/Pod Blueprint</strong>.</p><p><img loading="lazy" src="/ncm301/assets/images/create_blueprint-8a195c53fedd7702fae3070fb9fe9dec.png" width="422" height="198" class="img_ev3q"></p></li><li><p>Fill out the following fields and click <strong>Proceed</strong>:</p><ul><li><strong>Name</strong> - <em>Initials</em>-EScript</li><li><strong>Description</strong> - My First EScript Blueprint</li><li><strong>Project</strong> - <em>Initials</em>-Calm</li></ul></li><li><p>From the toolbar along the top of the blueprint, click <strong>Credentials</strong>.</p></li><li><p>Click <strong>Credentials</strong> <code>+</code> sign and fill out the following fields:</p><ul><li><strong>Credential Name</strong> - PC_Creds</li><li><strong>Username</strong> - admin</li><li><strong>Secret Type</strong> - Password</li><li><strong>Password</strong> - <em>Your Prism Central admin Password</em></li></ul><p><img loading="lazy" src="/ncm301/assets/images/credentials-ad9ae3c22615eb019903e608a50bbbbc.png" width="313" height="411" class="img_ev3q"></p></li><li><p>Click <strong>Save</strong> and then <strong>Back</strong>, ensuring no errors or warnings appear.</p></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-existing-machine-services">Using Existing Machine Services<a href="#using-existing-machine-services" class="hash-link" aria-label="Direct link to Using Existing Machine Services" title="Direct link to Using Existing Machine Services">​</a></h2><ol><li><p>In <strong>Application Overview <!-- -->&gt;<!-- --> Services</strong>, click <code>plus-circle</code>{.interpreted-text role=&quot;fa&quot;} to add a new Service.</p></li><li><p>Under the <strong>VM</strong> tab, fill in the following fields:</p><ul><li><strong>Service Name</strong>               - PC</li><li><strong>Name</strong>                      - PrismCentral</li><li><strong>Cloud</strong>                     - Existing Machine</li><li><strong>Operating System</strong>          - Linux</li><li><strong>IP Address</strong>                - localhost</li><li><strong>Check log-in upon create</strong>  - <strong>Unselect</strong></li><li><strong>Credential</strong>               - Leave default</li><li><strong>Address</strong>                  - Leave default</li><li><strong>Connection Type</strong>         - Leave default</li><li><strong>Connection Port</strong>         - Leave default</li><li><strong>Delay</strong>                   - Leave default</li></ul><p><img loading="lazy" src="/ncm301/assets/images/existing_machine-7259bd606da2ae25acdcf8f64febbdeb.png" width="1133" height="888" class="img_ev3q"></p><p>There are several new and interesting items in the above configuration:</p><ul><li><strong>Cloud</strong> - Instead of creating a new VM on Nutanix or a public cloud provider, we&#x27;re instead choosing to automate against an
already existing machine. All that&#x27;s required for us to enteris an IP Address of the machine, which in our case is Prism Central. Depending on your use case, you may specify something
like Ansible Tower, or an Era Server, as an existing machine.</li><li><strong>IP Address</strong> - Since we&#x27;re going to be making API Calls against Prism Central, and Calm runs directly in Prism Central, we&#x27;re just entering localhost as an IP. If you were going to be
automating against something like Ansible Tower or Era, you would need to put your Ansible Tower or Era Server IP addresses in this field, rather than localhost. IP Address could also be
defined by a variable.</li><li><strong>Check log-in upon create</strong> - This is the first time we&#x27;ve seen this box unselected. Since EScript tasks run directly within Calm, there&#x27;s no need to SSH in to the Service in
question. Instead we&#x27;ll use credentials directly within the EScript code to authenticate our REST API call.</li></ul></li><li><p>Click <strong>Save</strong>, and ensure no errors or warnings appear.</p></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="restlist-custom-action">RESTList Custom Action<a href="#restlist-custom-action" class="hash-link" aria-label="Direct link to RESTList Custom Action" title="Direct link to RESTList Custom Action">​</a></h2><p>In this exercise, we are going to be creating a custom action for our application to make a REST API call against Prism Central. Specifically,
it will be a POST <code>/list</code> call, where the entity (kind) to be listed (e.g. apps, hosts, clusters, roles, etc.) will be defined by a variable at runtime. The results of this call will then be output.</p><ol><li><p>In the <strong>Application Overview <!-- -->&gt;<!-- --> Application Profile</strong> section, expand the <strong>Default</strong> Application Profile.</p><p><img loading="lazy" src="/ncm301/assets/images/addaction-b0e0180fa59376a0583bf99e37c1e767.png" width="319" height="423" class="img_ev3q"></p></li><li><p>Select <code>+</code> sign next to <strong>Actions</strong> to add a new, custom action.</p></li><li><p>On the <strong>Configuration Pane</strong> to the right, name the action <strong>RESTList</strong>, and add a single variable:</p><ul><li><strong>Name</strong> - kind</li><li><strong>Data Type</strong> - String</li><li><strong>Value</strong> - apps</li><li>Select <strong>Runtime</strong> by toggling the running man icon in the upper right to blue</li></ul><p><img loading="lazy" src="/ncm301/assets/images/restlist-d47edfe445a886e0bf71bad921add58d.png" width="1120" height="690" class="img_ev3q"></p><p>When running the custom action later, Calm will prompt the user for input. <strong>Apps</strong> will be pre-filled default value, but it can be changed prior to executing the script action.</p></li><li><p>Click the <strong>+ Task</strong> button to add a task to the <strong>RESTList</strong> custom action. Fill in the following fields:</p><ul><li><strong>Task Name</strong> - RuntimePost</li><li><strong>Type</strong> - Execute</li><li><strong>Script Type</strong> - EScript</li><li><strong>Script</strong> - <em>Script Provided Below</em></li></ul><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Set the credentials</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc_user </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;@@{PC_Creds.username}@@&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pc_pass </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;@@{PC_Creds.secret}@@&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Set the headers, url, and payload</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">headers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;Content-Type&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;application/json&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Accept&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;application/json&#x27;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">url     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://@@{address}@@:9440/api/nutanix/v3/@@{kind}@@vms/list&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Make the request</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> urlreq</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> verb</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;POST&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> auth</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;BASIC&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> user</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">pc_user</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> passwd</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">pc_pass</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> params</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dumps</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">payload</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> headers</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">headers</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># If the request went through correctly, print it out.  Otherwise error out, and print the response.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> resp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ok</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">print</span><span class="token plain"> json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dumps</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loads</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">content</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> indent</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">print</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Post request failed&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">content</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="/ncm301/assets/images/runtime_post-3e490317885fb57854578d642e911ab7.png" width="1136" height="640" class="img_ev3q"></p><p>There are some new and interesting features of this task:</p><p>Note how there is not a Credential dropdown within the Calm UI, and instead we\&#x27;re setting Python variables equal to our PC_Creds
username and password specified earlier. Other APIs may not require authentication, or require an API key to be provided as part of the URL.</p><p>We also see the <a href="https://portal.nutanix.com/#/page/docs/details?targetId=Nutanix-Calm-Admin-Operations-Guide-v250:nuc-supported-escript-modules-functions-c.html" target="_blank" rel="noopener noreferrer">urlreq</a>
module being used, which is the exact line that our API call is made. If the response returns as expected, the JSON response will be
formatted and printed, otherwise the corresponding error message will be printed.</p></li><li><p>Click <strong>Save</strong>, and ensure no errors or warnings appear.</p></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="getdefaultsubnet-custom-action">GetDefaultSubnet Custom Action<a href="#getdefaultsubnet-custom-action" class="hash-link" aria-label="Direct link to GetDefaultSubnet Custom Action" title="Direct link to GetDefaultSubnet Custom Action">​</a></h2><p>In this exercise, we are going to create an additional custom action to make a different REST API call. The call will return the list of
<strong>Projects</strong> on this Prism Central instance. We will then parse the output of that API call to get the UUID of the default subnet configured
for the project that the running application belongs to. This UUID will be set as a Calm variable, allowing for re-use elsewhere in the
blueprint. We will then do another Rest API call, a GET on the default subnet (utilizing this newly set variable).</p><ol><li><p>Select the <strong>PC</strong> service. In the <strong>Configuration Pane</strong>, select the <strong>Service</strong> tab. Add a variable named <strong>SUBNET</strong>, leaving all other
fields blank.</p><p><img loading="lazy" src="/ncm301/assets/images/subnet_variable-0e063df5c1b40ec5c7c7c9bcdf5fc927.png" width="1219" height="790" class="img_ev3q"></p></li><li><p>In the <strong>Application Overview &gt; Application Profile &gt; Default</strong>, section, select <code>+</code> sign next to <strong>Actions</strong> to add a new, custom action.</p></li><li><p>Name the action <strong>GetDefaultSubnet</strong>.</p><p><img loading="lazy" src="/ncm301/assets/images/get_default_subnet-915edf38ff19de380248eb504f37290a.png" width="1129" height="678" class="img_ev3q"></p></li><li><p>Click the <strong>+ Task</strong> button to add a task to the <strong>GetDefaultSubnet</strong> custom action. Fill in the following fields:</p><ul><li><strong>Task Name</strong> - GetSubnetUUID</li><li><strong>Type</strong> - Set Variable</li><li><strong>Script Type</strong> - EScript</li><li><strong>Script</strong> - <em>Script Provided Below</em></li><li><strong>Output</strong> - SUBNET</li></ul><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Get the JWT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jwt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;@@{calm_jwt}@@&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Set the headers, url, and payload</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">headers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;Content-Type&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;application/json&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Accept&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;application/json&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Authorization&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bearer {}&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">jwt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">url     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://@@{address}@@:9440/api/nutanix/v3/projects/list&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Make the request</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> urlreq</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> verb</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;POST&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> params</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dumps</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">payload</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> headers</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">headers</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> verify</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># If the request went through correctly</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> resp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ok</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Cycle through the project &quot;entities&quot;, and check if its name matches the current project</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> project </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loads</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">content</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;entities&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> project</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;spec&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;name&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;@@{calm_project_name}@@&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic"># If there&#x27;s a default subnet reference, print UUID to set variable and exit success, otherwise error out</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;uuid&#x27;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> project</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;status&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;resources&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;default_subnet_reference&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword" style="color:#00009f">print</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;SUBNET={0}&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">project</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;status&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;resources&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;default_subnet_reference&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&#x27;uuid&#x27;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       exit </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword" style="color:#00009f">print</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;The &#x27;@@{calm_project_name}@@&#x27; project does not have a default subnet set.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># If we&#x27;ve reached this point in the code, none of our projects matched the calm_project_name macro</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">print</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;The &#x27;@@{calm_project_name}@@&#x27; project does not match any of our /projects/list api call.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">print</span><span class="token plain"> json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dumps</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loads</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">content</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> indent</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># In case the request returns an error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">print</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Post clusters/list request failed&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">content</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="/ncm301/assets/images/get_subnet_uuid-b98d12cd8d3bb0888e273fb4109ecd4a.png" width="1135" height="797" class="img_ev3q"></p><p>There are two key differences between the <strong>RESTList</strong> and <strong>GetDefaultSubnet</strong> tasks. The first difference is the use of the
<strong>Set Variable</strong> task type. Take note of the <strong>print &quot;SUBNET={0}&quot;</strong> line: Calm will parse output in the format of <strong>variable=value</strong>, and set the variable equal to the value. In this
example, we are printing the variable called <strong>SUBNET</strong> is equal to the UUID of the \&quot;default_subnet_reference\&quot; field in the initial
API call response. In the <strong>Output</strong> field below the Script body, we must paste in the variable name for Calm to set the variable
appropriately. The variable must already be defined in the Calm blueprint, whether globally, or in this case, as a variable local to the <strong>PC</strong> service.</p><p>The second difference is that the <strong>PC_Cred</strong> credential was not used to authorize the API call against Prism Central. Instead,
we are using a <a href="https://en.wikipedia.org/wiki/JSON_Web_Token" target="_blank" rel="noopener noreferrer">JSON Web Token</a> provided by the built-in <strong>calm_jwt</strong> macro.</p></li><li><p>Click the <strong>+ Task</strong> button again to add a second task to the <strong>GetDefaultSubnet</strong> custom action. Fill in the following fields:</p><ul><li><strong>Task Name</strong> - GetSubnetInfo</li><li><strong>Type</strong> - Execute</li><li><strong>Script Type</strong> - EScript</li><li><strong>Script</strong> - <em>Script Provided Below</em></li></ul><div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># Get the JWT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">jwt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;@@{calm_jwt}@@&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Set the headers, url, and payload</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">headers </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&#x27;Content-Type&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;application/json&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Accept&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;application/json&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Authorization&#x27;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bearer {}&#x27;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">jwt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">url     </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://@@{address}@@:9440/api/nutanix/v3/subnets/@@{SUBNET}@@&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">payload </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Make the request</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">resp </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> urlreq</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> verb</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&#x27;GET&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> params</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dumps</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">payload</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> headers</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">headers</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> verify</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># If the request went through correctly, print it out.  Otherwise error out, and print the response.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> resp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ok</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">print</span><span class="token plain"> json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dumps</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loads</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">resp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">content</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> indent</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">else</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">print</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Get request failed&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> resp</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">content</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In this task we\&#x27;re dynamically returning details about the default subnet using a GET API call and the <strong>SUBNET</strong> UUID variable returned by the previous task.</p><p><img loading="lazy" src="/ncm301/assets/images/get_subnet_info-46aa9ef489261690e136dd6ebb98f3cc.png" width="1135" height="644" class="img_ev3q"></p></li><li><p>Click <strong>Save</strong>, and ensure no errors or warnings appear.</p></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="running-the-custom-actions">Running the Custom Actions<a href="#running-the-custom-actions" class="hash-link" aria-label="Direct link to Running the Custom Actions" title="Direct link to Running the Custom Actions">​</a></h2><ol><li><p><strong>Launch</strong> the blueprint. Name the application *Initials<strong>*-RestCalls</strong>, and then click <strong>Create</strong>.</p><p>The <strong>Create</strong> task should complete quickly, as no VMs are being provisioned or Package Install scripts being run.</p></li><li><p>Once the application reaches <strong>Running</strong> status, select the <strong>Manage</strong> tab.</p><p><img loading="lazy" src="/ncm301/assets/images/app_create-139b62d33cc6adf85e7733857a186611.png" width="1135" height="682" class="img_ev3q"></p></li><li><p>Next, run the <strong>RESTList</strong> action by clicking its <code>play</code> icon. A new window appears displaying the <strong>kind</strong> variable and default <strong>apps</strong> value. Click <strong>Run</strong>.</p><p><img loading="lazy" src="/ncm301/assets/images/apps_run-1ca4e391e60875e3cfb5d48288e3cdf0.png" width="643" height="314" class="img_ev3q"></p></li><li><p>In the output on the right pane, maximize the <strong>RuntimePost</strong> task, and view the API output. The output pane can be toggled by clicking
the <code>eye</code> icon. Maximize theoutput/script window to make viewing easier. As expected, the script returns a JSON body with an array describing each launched
application in Calm.</p><p><img loading="lazy" src="/ncm301/assets/images/apps_run2-2c2dc544d95d3538dc316617bb6efe79.png" width="1135" height="724" class="img_ev3q"></p></li><li><p>Run the <strong>RESTList</strong> action again, altering the value to another <a href="https://developer.nutanix.com/reference/prism_central/v3/" target="_blank" rel="noopener noreferrer">Prism Central API entity</a>, such as <strong>images</strong>, <strong>clusters</strong>, <strong>hosts</strong>, or <strong>vms</strong>.</p></li><li><p>Finally, run the <strong>GetDefaultSubnet</strong> action. Expand both the <strong>GetSubnetUUID</strong> and <strong>GetSubnetInfo</strong> tasks, reviewing the output for each task. What is the name and VLAN id of your default subnet?</p><p><img loading="lazy" src="/ncm301/assets/images/GetDefaultSubnet-77d6f12e45a3aef2b9c88edd9d8d28fa.png" width="1135" height="886" class="img_ev3q"></p><p><img loading="lazy" src="/ncm301/assets/images/GetDefaultSubnet2-3b28013807be6f25cd835429ae738b3c.png" width="927" height="616" class="img_ev3q"></p></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="publishing-to-the-task-library">Publishing to the Task Library<a href="#publishing-to-the-task-library" class="hash-link" aria-label="Direct link to Publishing to the Task Library" title="Direct link to Publishing to the Task Library">​</a></h2><p>Tasks such as common API calls, package installations for common services, domain joins, etc. can be broadly applicable to multiple blueprints. These tasks can be used without leveraging third party tools or manually copying and pasting scripts by instead publishing into the
Task Library, Calm&#x27;s central repository for code re-use.</p><ol><li><p>Open your <em>Initials</em>-EScript blueprint in the Blueprint Editor.</p></li><li><p>In the <strong>Application Overview &gt; Application Profile</strong> pane, select the <strong>RESTList</strong> action.</p></li><li><p>Select the <strong>RuntimeList</strong> task to open the task in the <strong>Configuration Pane</strong>.</p></li><li><p>Click <strong>Publish to Library</strong>.</p></li><li><p>In the <strong>Publish Task</strong> window, make the following changes:</p><ul><li><strong>Name</strong> - <em>Initials</em> Prism Central Runtime List</li><li>Replace <strong>address</strong> with <strong>Prism_Central_IP</strong></li></ul><p><img loading="lazy" src="/ncm301/assets/images/publish_task-9f4445c5d325c32869217881a765fedc.png" width="916" height="649" class="img_ev3q"></p></li><li><p>Click <strong>Apply</strong> and note that the original <strong>address</strong> macro was replaced with <strong>Prism_Central_IP</strong> in the script window. Replacing
macro names allows you to be more generic or descriptive to increase task portability.</p></li><li><p>Click <strong>Publish</strong>.</p></li><li><p>Open the <strong>Task Library</strong> in the sidebar. Select your published task. By default, the task will be available to the project from which it was originally published, but you can specify additional
projects with which to share the task.</p></li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="takeaways">Takeaways<a href="#takeaways" class="hash-link" aria-label="Direct link to Takeaways" title="Direct link to Takeaways">​</a></h2><p>What are the key things you should know about <strong>Nutanix Calm</strong>?</p><ul><li>The task library allows commonly used operations to be written once and reused over and over again. As time goes on more objects will be
integrated into the task library, from Nutanix-provided common tasks to entire service objects</li><li>Calm 2.7 introduced the HTTP task, allowing the most common use of Escript to be more easily implemented (sending API calls)</li><li>In addition to being able to use Bash and Powershell scripts, Nutanix Calm can use EScript, which is a sandboxed Python interpreter, to provide application lifecycle management.</li><li>EScript tasks are run directly within the Calm engine, rather than being executed on the remote machine.</li><li>Shell, Powershell, and EScript tasks can all be utilized to set a variable based on script output. That variable can then be used in
other portions of the blueprint.</li><li>The Task Library allows for publishing of commonly used tasks into a central repository, giving the ability to share these scripts across Projects and Blueprints.</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/mat0606/ncm301/edit/main/docs/calm_escript/calm_escript.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/ncm301/calm_linux_track/calm_day2_linux/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Linux Day 2 Operations</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/ncm301/calm_aws/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Gateway to Infrastructure</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#lab-setup" class="table-of-contents__link toc-highlight">Lab Setup</a></li><li><a href="#using-existing-machine-services" class="table-of-contents__link toc-highlight">Using Existing Machine Services</a></li><li><a href="#restlist-custom-action" class="table-of-contents__link toc-highlight">RESTList Custom Action</a></li><li><a href="#getdefaultsubnet-custom-action" class="table-of-contents__link toc-highlight">GetDefaultSubnet Custom Action</a></li><li><a href="#running-the-custom-actions" class="table-of-contents__link toc-highlight">Running the Custom Actions</a></li><li><a href="#publishing-to-the-task-library" class="table-of-contents__link toc-highlight">Publishing to the Task Library</a></li><li><a href="#takeaways" class="table-of-contents__link toc-highlight">Takeaways</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2023 Calm Automation Bootcamp. Built with Docusaurus.</div></div></div></footer></div>
<script src="/ncm301/assets/js/runtime~main.b995eb59.js"></script>
<script src="/ncm301/assets/js/main.2f042511.js"></script>
</body>
</html>