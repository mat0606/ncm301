"use strict";(self.webpackChunkncm_301=self.webpackChunkncm_301||[]).push([[9067],{3905:(e,t,a)=>{a.d(t,{Zo:()=>c,kt:()=>k});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var p=n.createContext({}),o=function(e){var t=n.useContext(p),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},c=function(e){var t=o(e.components);return n.createElement(p.Provider,{value:t},e.children)},m="mdxType",u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},d=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,i=e.originalType,p=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),m=o(a),d=r,k=m["".concat(p,".").concat(d)]||m[d]||u[d]||i;return a?n.createElement(k,l(l({ref:t},c),{},{components:a})):n.createElement(k,l({ref:t},c))}));function k(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=a.length,l=new Array(i);l[0]=d;var s={};for(var p in t)hasOwnProperty.call(t,p)&&(s[p]=t[p]);s.originalType=e,s[m]="string"==typeof e?e:r,l[1]=s;for(var o=2;o<i;o++)l[o]=a[o];return n.createElement.apply(null,l)}return n.createElement.apply(null,a)}d.displayName="MDXCreateElement"},76517:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>p,contentTitle:()=>l,default:()=>u,frontMatter:()=>i,metadata:()=>s,toc:()=>o});var n=a(87462),r=(a(67294),a(3905));const i={title:"EScript and Task Library"},l="NCM Self Service: EScript and Task Library",s={unversionedId:"calm_escript/calm_escript",id:"calm_escript/calm_escript",title:"EScript and Task Library",description:"Overview",source:"@site/docs/calm_escript/calm_escript.mdx",sourceDirName:"calm_escript",slug:"/calm_escript/",permalink:"/ncm301/calm_escript/",draft:!1,editUrl:"https://github.com/mat0606/ncm301/edit/main/docs/calm_escript/calm_escript.mdx",tags:[],version:"current",frontMatter:{title:"EScript and Task Library"},sidebar:"tutorialSidebar",previous:{title:"Linux Day 2 Operations",permalink:"/ncm301/calm_linux_track/calm_day2_linux/"},next:{title:"Gateway to Infrastructure",permalink:"/ncm301/calm_aws/"}},p={},o=[{value:"Overview",id:"overview",level:2},{value:"Lab Setup",id:"lab-setup",level:2},{value:"Using Existing Machine Services",id:"using-existing-machine-services",level:2},{value:"RESTList Custom Action",id:"restlist-custom-action",level:2},{value:"GetDefaultSubnet Custom Action",id:"getdefaultsubnet-custom-action",level:2},{value:"Running the Custom Actions",id:"running-the-custom-actions",level:2},{value:"Publishing to the Task Library",id:"publishing-to-the-task-library",level:2},{value:"Takeaways",id:"takeaways",level:2}],c={toc:o},m="wrapper";function u(e){let{components:t,...i}=e;return(0,r.kt)(m,(0,n.Z)({},c,i,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"ncm-self-service-escript-and-task-library"},"NCM Self Service: EScript and Task Library"),(0,r.kt)("h2",{id:"overview"},"Overview"),(0,r.kt)("p",null,"In the ",(0,r.kt)("a",{parentName:"p",href:"/ncm301/calm_linux_track/calm_iaas_linux/"},"Calm Linux")," and ",(0,r.kt)("a",{parentName:"p",href:"/ncm301/calm_windows_track/calm_iaas_windows/"},"Calm Windows"),"  labs you explored how Calm can utilize Bash and PowerShell scripts to automate application deployments. While shell scripts can be both powerful and versatile, they require the\ndeployment of an endpoint VM on which to copy and execute the script locally."),(0,r.kt)("p",null,"There are use cases that would be better served to execute code directly within NCM Self Service, such as making API calls to other RESTful services like Nutanix Era, GitHub, IFTTT, etc."),(0,r.kt)("p",null,"To fill this need, NCM Self Service offers a script type called ",(0,r.kt)("a",{parentName:"p",href:"https://portal.nutanix.com/#/page/docs/details?targetId=Nutanix-Calm-Admin-Operations-Guide-v250:nuc-supported-escript-modules-functions-c.html"},"EScript"),".\nShort for Epsilon Script (Epsilon is the orchestration engine that drives Calm), EScript is a sandboxed Python interpreter. It contains many commonly used modules for scripting and automation. In particular, it contains the ",(0,r.kt)("strong",{parentName:"p"},"requests")," module as ",(0,r.kt)("strong",{parentName:"p"},"urlreq"),", used to create external API calls."),(0,r.kt)("admonition",{type:"info"},(0,r.kt)("p",{parentName:"admonition"},"The interpreter is sandboxed because the script runs ",(0,r.kt)("strong",{parentName:"p"},"directly")," within the Calm engine, which means it runs directly within Prism Central. Allowing the user to import unknown and unvetted modules into Prism Central is a security concern.")),(0,r.kt)("p",null,"In this lab you will leverage EScript to perform API calls against an existing web service, your Prism Central VM. You will also leverage Set Variable to set the data returned from an API call to a Calm macro, and\nthe Task Library to understand how common code can be used across multiple blueprints or projects."),(0,r.kt)("h2",{id:"lab-setup"},"Lab Setup"),(0,r.kt)("p",null,"This lab assumes basic familiarity with Nutanix Calm."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"It does NOT require the Task Manager application deployed as part of other Calm labs.")," Instead, you will create a new, blank Blueprint and add a credential used to authenticate to Prism Central."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"In ",(0,r.kt)("strong",{parentName:"p"},"Prism Central"),", select ",(0,r.kt)("strong",{parentName:"p"},"Menu > Services > Calm > Blueprints"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Click ",(0,r.kt)("strong",{parentName:"p"},"+ Create Blueprint > Multi VM/Pod Blueprint"),"."),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{src:a(88473).Z,width:"422",height:"198"}))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Fill out the following fields and click ",(0,r.kt)("strong",{parentName:"p"},"Proceed"),":"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Name")," - ",(0,r.kt)("em",{parentName:"li"},"Initials"),"-EScript"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Description")," - My First EScript Blueprint"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Project")," - ",(0,r.kt)("em",{parentName:"li"},"Initials"),"-Calm"))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"From the toolbar along the top of the blueprint, click ",(0,r.kt)("strong",{parentName:"p"},"Credentials"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Click ",(0,r.kt)("strong",{parentName:"p"},"Credentials")," ",(0,r.kt)("inlineCode",{parentName:"p"},"+")," sign and fill out the following fields:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Credential Name")," - PC_Creds"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Username")," - admin"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Secret Type")," - Password"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Password")," - ",(0,r.kt)("em",{parentName:"li"},"Your Prism Central admin Password"))),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{src:a(67343).Z,width:"313",height:"411"}))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Click ",(0,r.kt)("strong",{parentName:"p"},"Save")," and then ",(0,r.kt)("strong",{parentName:"p"},"Back"),", ensuring no errors or warnings appear."))),(0,r.kt)("h2",{id:"using-existing-machine-services"},"Using Existing Machine Services"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"In ",(0,r.kt)("strong",{parentName:"p"},"Application Overview ",">"," Services"),", click ",(0,r.kt)("inlineCode",{parentName:"p"},"plus-circle"),'{.interpreted-text role="fa"} to add a new Service.')),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Under the ",(0,r.kt)("strong",{parentName:"p"},"VM")," tab, fill in the following fields:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Service Name"),"               - PC"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Name"),"                      - PrismCentral"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Cloud"),"                     - Existing Machine"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Operating System"),"          - Linux"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"IP Address"),"                - localhost"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Check log-in upon create"),"  - ",(0,r.kt)("strong",{parentName:"li"},"Unselect")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Credential"),"               - Leave default"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Address"),"                  - Leave default"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Connection Type"),"         - Leave default"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Connection Port"),"         - Leave default"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Delay"),"                   - Leave default")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{src:a(18618).Z,width:"1133",height:"888"})),(0,r.kt)("p",{parentName:"li"},"There are several new and interesting items in the above configuration:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Cloud")," - Instead of creating a new VM on Nutanix or a public cloud provider, we're instead choosing to automate against an\nalready existing machine. All that's required for us to enteris an IP Address of the machine, which in our case is Prism Central. Depending on your use case, you may specify something\nlike Ansible Tower, or an Era Server, as an existing machine."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"IP Address")," - Since we're going to be making API Calls against Prism Central, and Calm runs directly in Prism Central, we're just entering localhost as an IP. If you were going to be\nautomating against something like Ansible Tower or Era, you would need to put your Ansible Tower or Era Server IP addresses in this field, rather than localhost. IP Address could also be\ndefined by a variable."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Check log-in upon create")," - This is the first time we've seen this box unselected. Since EScript tasks run directly within Calm, there's no need to SSH in to the Service in\nquestion. Instead we'll use credentials directly within the EScript code to authenticate our REST API call."))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Click ",(0,r.kt)("strong",{parentName:"p"},"Save"),", and ensure no errors or warnings appear."))),(0,r.kt)("h2",{id:"restlist-custom-action"},"RESTList Custom Action"),(0,r.kt)("p",null,"In this exercise, we are going to be creating a custom action for our application to make a REST API call against Prism Central. Specifically,\nit will be a POST ",(0,r.kt)("inlineCode",{parentName:"p"},"/list")," call, where the entity (kind) to be listed (e.g. apps, hosts, clusters, roles, etc.) will be defined by a variable at runtime. The results of this call will then be output."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"In the ",(0,r.kt)("strong",{parentName:"p"},"Application Overview ",">"," Application Profile")," section, expand the ",(0,r.kt)("strong",{parentName:"p"},"Default")," Application Profile."),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{src:a(15062).Z,width:"319",height:"423"}))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Select ",(0,r.kt)("inlineCode",{parentName:"p"},"+")," sign next to ",(0,r.kt)("strong",{parentName:"p"},"Actions")," to add a new, custom action.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"On the ",(0,r.kt)("strong",{parentName:"p"},"Configuration Pane")," to the right, name the action ",(0,r.kt)("strong",{parentName:"p"},"RESTList"),", and add a single variable:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Name")," - kind"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Data Type")," - String"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Value")," - apps"),(0,r.kt)("li",{parentName:"ul"},"Select ",(0,r.kt)("strong",{parentName:"li"},"Runtime")," by toggling the running man icon in the upper right to blue")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{src:a(83894).Z,width:"1120",height:"690"})),(0,r.kt)("p",{parentName:"li"},"When running the custom action later, Calm will prompt the user for input. ",(0,r.kt)("strong",{parentName:"p"},"Apps")," will be pre-filled default value, but it can be changed prior to executing the script action.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Click the ",(0,r.kt)("strong",{parentName:"p"},"+ Task")," button to add a task to the ",(0,r.kt)("strong",{parentName:"p"},"RESTList")," custom action. Fill in the following fields:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Task Name")," - RuntimePost"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Type")," - Execute"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Script Type")," - EScript"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Script")," - ",(0,r.kt)("em",{parentName:"li"},"Script Provided Below"))),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-python"},"# Set the credentials\npc_user = '@@{PC_Creds.username}@@'\npc_pass = '@@{PC_Creds.secret}@@'\n\n# Set the headers, url, and payload\nheaders = {'Content-Type': 'application/json', 'Accept': 'application/json'}\nurl     = \"https://@@{address}@@:9440/api/nutanix/v3/@@{kind}@@vms/list\"\npayload = {}\n\n# Make the request\nresp = urlreq(url, verb='POST', auth='BASIC', user=pc_user, passwd=pc_pass, params=json.dumps(payload), headers=headers)\n\n# If the request went through correctly, print it out.  Otherwise error out, and print the response.\nif resp.ok:\n   print json.dumps(json.loads(resp.content), indent=4)\n   exit(0)\nelse:\n   print \"Post request failed\", resp.content\n   exit(1)\n")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{src:a(29741).Z,width:"1136",height:"640"})),(0,r.kt)("p",{parentName:"li"},"There are some new and interesting features of this task:"),(0,r.kt)("p",{parentName:"li"},"Note how there is not a Credential dropdown within the Calm UI, and instead we\\'re setting Python variables equal to our PC_Creds\nusername and password specified earlier. Other APIs may not require authentication, or require an API key to be provided as part of the URL."),(0,r.kt)("p",{parentName:"li"},"We also see the ",(0,r.kt)("a",{parentName:"p",href:"https://portal.nutanix.com/#/page/docs/details?targetId=Nutanix-Calm-Admin-Operations-Guide-v250:nuc-supported-escript-modules-functions-c.html"},"urlreq"),"\nmodule being used, which is the exact line that our API call is made. If the response returns as expected, the JSON response will be\nformatted and printed, otherwise the corresponding error message will be printed.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Click ",(0,r.kt)("strong",{parentName:"p"},"Save"),", and ensure no errors or warnings appear."))),(0,r.kt)("h2",{id:"getdefaultsubnet-custom-action"},"GetDefaultSubnet Custom Action"),(0,r.kt)("p",null,"In this exercise, we are going to create an additional custom action to make a different REST API call. The call will return the list of\n",(0,r.kt)("strong",{parentName:"p"},"Projects")," on this Prism Central instance. We will then parse the output of that API call to get the UUID of the default subnet configured\nfor the project that the running application belongs to. This UUID will be set as a Calm variable, allowing for re-use elsewhere in the\nblueprint. We will then do another Rest API call, a GET on the default subnet (utilizing this newly set variable)."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Select the ",(0,r.kt)("strong",{parentName:"p"},"PC")," service. In the ",(0,r.kt)("strong",{parentName:"p"},"Configuration Pane"),", select the ",(0,r.kt)("strong",{parentName:"p"},"Service")," tab. Add a variable named ",(0,r.kt)("strong",{parentName:"p"},"SUBNET"),", leaving all other\nfields blank."),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{src:a(42651).Z,width:"1219",height:"790"}))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"In the ",(0,r.kt)("strong",{parentName:"p"},"Application Overview > Application Profile > Default"),", section, select ",(0,r.kt)("inlineCode",{parentName:"p"},"+")," sign next to ",(0,r.kt)("strong",{parentName:"p"},"Actions")," to add a new, custom action.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Name the action ",(0,r.kt)("strong",{parentName:"p"},"GetDefaultSubnet"),"."),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{src:a(5764).Z,width:"1129",height:"678"}))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Click the ",(0,r.kt)("strong",{parentName:"p"},"+ Task")," button to add a task to the ",(0,r.kt)("strong",{parentName:"p"},"GetDefaultSubnet")," custom action. Fill in the following fields:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Task Name")," - GetSubnetUUID"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Type")," - Set Variable"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Script Type")," - EScript"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Script")," - ",(0,r.kt)("em",{parentName:"li"},"Script Provided Below")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Output")," - SUBNET")),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-python"},"# Get the JWT\njwt = '@@{calm_jwt}@@'\n\n# Set the headers, url, and payload\nheaders = {'Content-Type': 'application/json', 'Accept': 'application/json', 'Authorization': 'Bearer {}'.format(jwt)}\nurl     = \"https://@@{address}@@:9440/api/nutanix/v3/projects/list\"\npayload = {}\n\n# Make the request\nresp = urlreq(url, verb='POST', params=json.dumps(payload), headers=headers, verify=False)\n\n# If the request went through correctly\nif resp.ok:\n\n # Cycle through the project \"entities\", and check if its name matches the current project\n for project in json.loads(resp.content)['entities']:\n   if project['spec']['name'] == '@@{calm_project_name}@@':\n\n     # If there's a default subnet reference, print UUID to set variable and exit success, otherwise error out\n     if 'uuid' in project['status']['resources']['default_subnet_reference']:\n       print \"SUBNET={0}\".format(project['status']['resources']['default_subnet_reference']['uuid'])\n       exit (0)\n     else:\n       print \"The '@@{calm_project_name}@@' project does not have a default subnet set.\"\n       exit(1)\n\n # If we've reached this point in the code, none of our projects matched the calm_project_name macro\n print \"The '@@{calm_project_name}@@' project does not match any of our /projects/list api call.\"\n print json.dumps(json.loads(resp.content), indent=4)\n exit(0)\n\n# In case the request returns an error\nelse:\n print \"Post clusters/list request failed\", resp.content\n exit(1)\n")),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{src:a(52930).Z,width:"1135",height:"797"})),(0,r.kt)("p",{parentName:"li"},"There are two key differences between the ",(0,r.kt)("strong",{parentName:"p"},"RESTList")," and ",(0,r.kt)("strong",{parentName:"p"},"GetDefaultSubnet")," tasks. The first difference is the use of the\n",(0,r.kt)("strong",{parentName:"p"},"Set Variable")," task type. Take note of the ",(0,r.kt)("strong",{parentName:"p"},'print "SUBNET={0}"')," line: Calm will parse output in the format of ",(0,r.kt)("strong",{parentName:"p"},"variable=value"),", and set the variable equal to the value. In this\nexample, we are printing the variable called ",(0,r.kt)("strong",{parentName:"p"},"SUBNET"),' is equal to the UUID of the \\"default_subnet_reference\\" field in the initial\nAPI call response. In the ',(0,r.kt)("strong",{parentName:"p"},"Output")," field below the Script body, we must paste in the variable name for Calm to set the variable\nappropriately. The variable must already be defined in the Calm blueprint, whether globally, or in this case, as a variable local to the ",(0,r.kt)("strong",{parentName:"p"},"PC")," service."),(0,r.kt)("p",{parentName:"li"},"The second difference is that the ",(0,r.kt)("strong",{parentName:"p"},"PC_Cred")," credential was not used to authorize the API call against Prism Central. Instead,\nwe are using a ",(0,r.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/JSON_Web_Token"},"JSON Web Token")," provided by the built-in ",(0,r.kt)("strong",{parentName:"p"},"calm_jwt")," macro.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Click the ",(0,r.kt)("strong",{parentName:"p"},"+ Task")," button again to add a second task to the ",(0,r.kt)("strong",{parentName:"p"},"GetDefaultSubnet")," custom action. Fill in the following fields:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Task Name")," - GetSubnetInfo"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Type")," - Execute"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Script Type")," - EScript"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Script")," - ",(0,r.kt)("em",{parentName:"li"},"Script Provided Below"))),(0,r.kt)("pre",{parentName:"li"},(0,r.kt)("code",{parentName:"pre",className:"language-python"},"# Get the JWT\njwt = '@@{calm_jwt}@@'\n\n# Set the headers, url, and payload\nheaders = {'Content-Type': 'application/json', 'Accept': 'application/json', 'Authorization': 'Bearer {}'.format(jwt)}\nurl     = \"https://@@{address}@@:9440/api/nutanix/v3/subnets/@@{SUBNET}@@\"\npayload = {}\n\n# Make the request\nresp = urlreq(url, verb='GET', params=json.dumps(payload), headers=headers, verify=False)\n\n# If the request went through correctly, print it out.  Otherwise error out, and print the response.\nif resp.ok:\n   print json.dumps(json.loads(resp.content), indent=4)\n   exit(0)\nelse:\n   print \"Get request failed\", resp.content\n   exit(1)\n")),(0,r.kt)("p",{parentName:"li"},"In this task we\\'re dynamically returning details about the default subnet using a GET API call and the ",(0,r.kt)("strong",{parentName:"p"},"SUBNET")," UUID variable returned by the previous task."),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{src:a(64381).Z,width:"1135",height:"644"}))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Click ",(0,r.kt)("strong",{parentName:"p"},"Save"),", and ensure no errors or warnings appear."))),(0,r.kt)("h2",{id:"running-the-custom-actions"},"Running the Custom Actions"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},(0,r.kt)("strong",{parentName:"p"},"Launch")," the blueprint. Name the application *Initials",(0,r.kt)("strong",{parentName:"p"},"*-RestCalls"),", and then click ",(0,r.kt)("strong",{parentName:"p"},"Create"),"."),(0,r.kt)("p",{parentName:"li"},"The ",(0,r.kt)("strong",{parentName:"p"},"Create")," task should complete quickly, as no VMs are being provisioned or Package Install scripts being run.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Once the application reaches ",(0,r.kt)("strong",{parentName:"p"},"Running")," status, select the ",(0,r.kt)("strong",{parentName:"p"},"Manage")," tab."),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{src:a(36602).Z,width:"1135",height:"682"}))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Next, run the ",(0,r.kt)("strong",{parentName:"p"},"RESTList")," action by clicking its ",(0,r.kt)("inlineCode",{parentName:"p"},"play")," icon. A new window appears displaying the ",(0,r.kt)("strong",{parentName:"p"},"kind")," variable and default ",(0,r.kt)("strong",{parentName:"p"},"apps")," value. Click ",(0,r.kt)("strong",{parentName:"p"},"Run"),"."),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{src:a(98680).Z,width:"643",height:"314"}))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"In the output on the right pane, maximize the ",(0,r.kt)("strong",{parentName:"p"},"RuntimePost")," task, and view the API output. The output pane can be toggled by clicking\nthe ",(0,r.kt)("inlineCode",{parentName:"p"},"eye")," icon. Maximize theoutput/script window to make viewing easier. As expected, the script returns a JSON body with an array describing each launched\napplication in Calm."),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{src:a(51085).Z,width:"1135",height:"724"}))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Run the ",(0,r.kt)("strong",{parentName:"p"},"RESTList")," action again, altering the value to another ",(0,r.kt)("a",{parentName:"p",href:"https://developer.nutanix.com/reference/prism_central/v3/"},"Prism Central API entity"),", such as ",(0,r.kt)("strong",{parentName:"p"},"images"),", ",(0,r.kt)("strong",{parentName:"p"},"clusters"),", ",(0,r.kt)("strong",{parentName:"p"},"hosts"),", or ",(0,r.kt)("strong",{parentName:"p"},"vms"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Finally, run the ",(0,r.kt)("strong",{parentName:"p"},"GetDefaultSubnet")," action. Expand both the ",(0,r.kt)("strong",{parentName:"p"},"GetSubnetUUID")," and ",(0,r.kt)("strong",{parentName:"p"},"GetSubnetInfo")," tasks, reviewing the output for each task. What is the name and VLAN id of your default subnet?"),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{src:a(68922).Z,width:"1135",height:"886"})),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{src:a(50150).Z,width:"927",height:"616"})))),(0,r.kt)("h2",{id:"publishing-to-the-task-library"},"Publishing to the Task Library"),(0,r.kt)("p",null,"Tasks such as common API calls, package installations for common services, domain joins, etc. can be broadly applicable to multiple blueprints. These tasks can be used without leveraging third party tools or manually copying and pasting scripts by instead publishing into the\nTask Library, Calm's central repository for code re-use."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Open your ",(0,r.kt)("em",{parentName:"p"},"Initials"),"-EScript blueprint in the Blueprint Editor.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"In the ",(0,r.kt)("strong",{parentName:"p"},"Application Overview > Application Profile")," pane, select the ",(0,r.kt)("strong",{parentName:"p"},"RESTList")," action.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Select the ",(0,r.kt)("strong",{parentName:"p"},"RuntimeList")," task to open the task in the ",(0,r.kt)("strong",{parentName:"p"},"Configuration Pane"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Click ",(0,r.kt)("strong",{parentName:"p"},"Publish to Library"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"In the ",(0,r.kt)("strong",{parentName:"p"},"Publish Task")," window, make the following changes:"),(0,r.kt)("ul",{parentName:"li"},(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Name")," - ",(0,r.kt)("em",{parentName:"li"},"Initials")," Prism Central Runtime List"),(0,r.kt)("li",{parentName:"ul"},"Replace ",(0,r.kt)("strong",{parentName:"li"},"address")," with ",(0,r.kt)("strong",{parentName:"li"},"Prism_Central_IP"))),(0,r.kt)("p",{parentName:"li"},(0,r.kt)("img",{src:a(71911).Z,width:"916",height:"649"}))),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Click ",(0,r.kt)("strong",{parentName:"p"},"Apply")," and note that the original ",(0,r.kt)("strong",{parentName:"p"},"address")," macro was replaced with ",(0,r.kt)("strong",{parentName:"p"},"Prism_Central_IP")," in the script window. Replacing\nmacro names allows you to be more generic or descriptive to increase task portability.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Click ",(0,r.kt)("strong",{parentName:"p"},"Publish"),".")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("p",{parentName:"li"},"Open the ",(0,r.kt)("strong",{parentName:"p"},"Task Library")," in the sidebar. Select your published task. By default, the task will be available to the project from which it was originally published, but you can specify additional\nprojects with which to share the task."))),(0,r.kt)("h2",{id:"takeaways"},"Takeaways"),(0,r.kt)("p",null,"What are the key things you should know about ",(0,r.kt)("strong",{parentName:"p"},"Nutanix Calm"),"?"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The task library allows commonly used operations to be written once and reused over and over again. As time goes on more objects will be\nintegrated into the task library, from Nutanix-provided common tasks to entire service objects"),(0,r.kt)("li",{parentName:"ul"},"Calm 2.7 introduced the HTTP task, allowing the most common use of Escript to be more easily implemented (sending API calls)"),(0,r.kt)("li",{parentName:"ul"},"In addition to being able to use Bash and Powershell scripts, Nutanix Calm can use EScript, which is a sandboxed Python interpreter, to provide application lifecycle management."),(0,r.kt)("li",{parentName:"ul"},"EScript tasks are run directly within the Calm engine, rather than being executed on the remote machine."),(0,r.kt)("li",{parentName:"ul"},"Shell, Powershell, and EScript tasks can all be utilized to set a variable based on script output. That variable can then be used in\nother portions of the blueprint."),(0,r.kt)("li",{parentName:"ul"},"The Task Library allows for publishing of commonly used tasks into a central repository, giving the ability to share these scripts across Projects and Blueprints.")))}u.isMDXComponent=!0},68922:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/GetDefaultSubnet-77d6f12e45a3aef2b9c88edd9d8d28fa.png"},50150:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/GetDefaultSubnet2-3b28013807be6f25cd835429ae738b3c.png"},15062:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/addaction-b0e0180fa59376a0583bf99e37c1e767.png"},36602:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/app_create-139b62d33cc6adf85e7733857a186611.png"},98680:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/apps_run-1ca4e391e60875e3cfb5d48288e3cdf0.png"},51085:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/apps_run2-2c2dc544d95d3538dc316617bb6efe79.png"},88473:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/create_blueprint-8a195c53fedd7702fae3070fb9fe9dec.png"},67343:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/credentials-ad9ae3c22615eb019903e608a50bbbbc.png"},18618:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/existing_machine-7259bd606da2ae25acdcf8f64febbdeb.png"},5764:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/get_default_subnet-915edf38ff19de380248eb504f37290a.png"},64381:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/get_subnet_info-46aa9ef489261690e136dd6ebb98f3cc.png"},52930:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/get_subnet_uuid-b98d12cd8d3bb0888e273fb4109ecd4a.png"},71911:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/publish_task-9f4445c5d325c32869217881a765fedc.png"},83894:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/restlist-d47edfe445a886e0bf71bad921add58d.png"},29741:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/runtime_post-3e490317885fb57854578d642e911ab7.png"},42651:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/images/subnet_variable-0e063df5c1b40ec5c7c7c9bcdf5fc927.png"}}]);